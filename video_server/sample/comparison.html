<!doctype html>
<html>
    <head>
        <title>Dash.js Rocks</title>
        <link rel="stylesheet" href="../contrib/akamai/controlbar/controlbar.css">

        <script src="../dist/dash.all.min.js"></script>
        <script src="../contrib/akamai/controlbar/ControlBar.js"></script>
        <script class="code" src="../contrib/akamai/controlbar/ControlBar.js"></script>
        <script src="./rules/LowestBitrateRule.js"></script>
        <script src="./rules/DownloadRatioRule.js"></script>
        <script src="./rules/ThroughputRule.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                startVideo();
            });
        </script>
        <script>
            var player1;
            var player2;
            var controlbar1;
            var controlbar2;
            const url = 'http://localhost/Manifest.mpd';
            function startVideo() {
                var video1 = document.querySelector(".videoContainer video");
                var video2 = document.querySelector(".videoContainer_2 video");

                player1 = dashjs.MediaPlayer().create();
                player2 = dashjs.MediaPlayer().create();

                player1.initialize(video1, url, true);
                player2.initialize(video2, url, true);

                controlbar1 = new ControlBar(player1);
                controlbar1.initialize();

                controlbar2 = new ControlBar(player2);
                controlbar2.initialize('_2');

                player1.on(dashjs.MediaPlayer.events["PLAYBACK_ENDED"], function() {
                    clearInterval(eventPoller);
                    clearInterval(bitrateCalculator);
                });
                player2.on(dashjs.MediaPlayer.events["PLAYBACK_ENDED"], function() {
                    clearInterval(eventPoller);
                    clearInterval(bitrateCalculator);
                });
                var eventPoller = setInterval(function() {
                    var streamInfo1 = player1.getActiveStream().getStreamInfo();
                    var dashMetrics1 = player1.getDashMetrics();
                    var dashAdapter1 = player1.getDashAdapter();

                    var streamInfo2 = player2.getActiveStream().getStreamInfo();
                    var dashMetrics2 = player2.getDashMetrics();
                    var dashAdapter2 = player2.getDashAdapter();

                    if (dashMetrics1 && streamInfo1) {
                        const periodIdx = streamInfo1.index;
                        var repSwitch = dashMetrics1.getCurrentRepresentationSwitch('video', true);
                        var bufferLevel = dashMetrics1.getCurrentBufferLevel('video', true);
                        var bitrate = repSwitch ? Math.round(dashAdapter1.getBandwidthForRepresentation(repSwitch.to, periodIdx) / 1000) : NaN;
                        document.getElementById('bufferLevel1').innerText = bufferLevel + " secs";
                        document.getElementById('reportedBitrate1').innerText = bitrate + " Kbps";
                    }

                    if (dashMetrics2 && streamInfo2) {
                        const periodIdx = streamInfo2.index;
                        var repSwitch = dashMetrics2.getCurrentRepresentationSwitch('video', true);
                        var bufferLevel = dashMetrics2.getCurrentBufferLevel('video', true);
                        var bitrate = repSwitch ? Math.round(dashAdapter2.getBandwidthForRepresentation(repSwitch.to, periodIdx) / 1000) : NaN;
                        document.getElementById('bufferLevel2').innerText = bufferLevel + " secs";
                        document.getElementById('reportedBitrate2').innerText = bitrate + " Kbps";
                    }
                }, 1000);
                if (video1.webkitVideoDecodedByteCount !== undefined) {
                    var lastDecodedByteCount = 0;
                    const bitrateInterval = 5;
                    var bitrateCalculator = setInterval(function() {
                        var calculatedBitrate = (((video1.webkitVideoDecodedByteCount - lastDecodedByteCount) / 1000) * 8) / bitrateInterval;
                        document.getElementById('calculatedBitrate1').innerText = Math.round(calculatedBitrate) + " Kbps";
                        lastDecodedByteCount = video1.webkitVideoDecodedByteCount;
                    }, bitrateInterval * 1000);
                }

                if (video2.webkitVideoDecodedByteCount !== undefined) {
                    var lastDecodedByteCount2 = 0;
                    const bitrateInterval2 = 5;
                    var bitrateCalculator2 = setInterval(function() {
                        var calculatedBitrate2 = (((video2.webkitVideoDecodedByteCount - lastDecodedByteCount2) / 1000) * 8) / bitrateInterval2;
                        document.getElementById('calculatedBitrate2').innerText = Math.round(calculatedBitrate2) + " Kbps";
                        lastDecodedByteCount2 = video2.webkitVideoDecodedByteCount;
                    }, bitrateInterval2 * 1000);
                } 
            }
            function configurePlayback(inp) {
                var controlbar;
                var player;
                var stableBuffer;
                var bufferAtTopQuality;
                var minBitrate;
                var maxBitrate;
                var abr;
                var changeAbr;
                if(inp == 1){
                    player = player1
                    controlbar = controlbar1
                    stableBuffer = parseInt(document.getElementById('stableBuffer1').value, 10);
                    bufferAtTopQuality = parseInt(document.getElementById('topQualityBuffer1').value, 10);
                    minBitrate = parseInt(document.getElementById('minBitrate1').value, 10);
                    maxBitrate = parseInt(document.getElementById('maxBitrate1').value, 10);
                    abr = document.getElementById('abr1').value;
                    changeAbr = document.getElementById('changeabr1').checked;
                }
                if(inp == 2){
                    player = player2
                    controlbar = controlbar2
                    stableBuffer = parseInt(document.getElementById('stableBuffer2').value, 10);
                    bufferAtTopQuality = parseInt(document.getElementById('topQualityBuffer2').value, 10);
                    minBitrate = parseInt(document.getElementById('minBitrate2').value, 10);
                    maxBitrate = parseInt(document.getElementById('maxBitrate2').value, 10);
                    abr = document.getElementById('abr2').value;
                    changeAbr = document.getElementById('changeabr2').checked;

                }


                player.updateSettings({
                    'streaming': {
                        'stableBufferTime': stableBuffer,
                        'bufferTimeAtTopQualityLongForm': bufferAtTopQuality,
                        'abr': {
                            'minBitrate': {
                                'video': minBitrate
                            },
                            'maxBitrate': {
                                'video': maxBitrate
                            }
                        }
                    }
                })
                if(changeAbr){
                    switch(abr){
                        case 'LowestBitrateRule':
                            player.removeABRCustomRule('ThroughputRule');
                            player.removeABRCustomRule('DownloadRatioRule');
                            player.addABRCustomRule('qualitySwitchRules', 'LowestBitrateRule', LowestBitrateRule);
                            player.updateSettings({
                                'streaming': {
                                    'abr': {
                                        'useDefaultABRRules': false,
                                        'ABRStrategy': 'LowestBitrateRule'
                                    }
                                }
                            });
                            break;
                        case 'DownloadRatioRule':
                            player.removeABRCustomRule('LowestBitrateRule');
                            player.removeABRCustomRule('ThroughputRule');
                            player.addABRCustomRule('qualitySwitchRules', 'DownloadRatioRule', DownloadRatioRule);
                            player.updateSettings({
                                'streaming': {
                                    'abr': {
                                        'useDefaultABRRules': false,
                                        'ABRStrategy': 'DownloadRatioRule'
                                    }
                                }
                            });
                            break;
                        case 'ThroughputRule':
                            player.removeABRCustomRule('LowestBitrateRule');
                            player.removeABRCustomRule('DownloadRatioRule');
                            player.addABRCustomRule('qualitySwitchRules', 'ThroughputRule', CustomThroughputRule);
                            player.updateSettings({
                                'streaming': {
                                    'abr': {
                                        'useDefaultABRRules': false,
                                        'ABRStrategy': 'ThroughputRule'
                                    }
                                }
                            });
                            break;
                        default:
                            player.removeABRCustomRule('LowestBitrateRule');
                            player.removeABRCustomRule('ThroughputRule');
                            player.removeABRCustomRule('DownloadRatioRule');
                            player.updateSettings({
                                'streaming': {
                                    'abr': {
                                        'useDefaultABRRules': true,
                                    }
                                }
                            });
                    }
                    player.attachSource(url);
                    controlbar.reset();
                }
            }
        </script>
        <style>
            video {
                width: 100%;
            }
            .dash-video-player {
                width: 640px;
                height: 320px;
                position: relative;
             }
        </style>
    </head>
    <body>
        <div>
            <div class="dash-video-player " style = "float: left;">
                <!-- HTML structure needed for the ControlBar -->
                <div class="videoContainer" id="videoContainer" >
                    <video class="dashjs-player1" preload="auto" autoplay="true"> </video>
                    <div id="videoController" class="video-controller unselectable">
                        <div id="playPauseBtn" class="btn-play-pause" title="Play/Pause">
                            <span id="iconPlayPause" class="icon-play"></span>
                        </div>
                        <span id="videoTime" class="time-display">00:00:00</span>
                        <div id="fullscreenBtn" class="btn-fullscreen control-icon-layout" title="Fullscreen">
                            <span class="icon-fullscreen-enter"></span>
                        </div>
                        <div id="bitrateListBtn" class="control-icon-layout" title="Bitrate List">
                            <span class="icon-bitrate"></span>
                        </div>
                        <input type="range" id="volumebar" class="volumebar" value="1" min="0" max="1" step=".01">
                        <div id="muteBtn" class="btn-mute control-icon-layout" title="Mute">
                            <span id="iconMute" class="icon-mute-off"></span>
                        </div>
                        <div id="trackSwitchBtn" class="control-icon-layout" title="A/V Tracks">
                            <span class="icon-tracks"></span>
                        </div>
                        <div id="captionBtn" class="btn-caption control-icon-layout" title="Closed Caption">
                            <span class="icon-caption"></span>
                        </div>
                        <span id="videoDuration" class="duration-display">00:00:00</span>
                        <div class="seekContainer">
                            <div id="seekbar" class="seekbar seekbar-complete">
                                <div id="seekbar-buffer" class="seekbar seekbar-buffer"></div>
                                <div id="seekbar-play" class="seekbar seekbar-play"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div style="margin-bottom: 200px">
                <Strong>Player 1 Statistics</strong>
                <br />
                <strong>Reported bitrate:</strong>
                <span id="reportedBitrate1"></span>
                <br />
                <strong>Buffer level:</strong>
                <span id="bufferLevel1"></span>
                <br />
                <strong>Calculated bitrate:</strong>
                <span id="calculatedBitrate1"></span>
                <fieldset>
                    <legend>Configuration parameters</legend>
                    <div>
                        Max stable buffer (seconds): <input type="number" id="stableBuffer1" value="20">
                    </div>
                    <div>
                        Buffer length at top quality (seconds): <input type="number" id="topQualityBuffer1" value="20">
                    </div>
                    <div>
                        Max selectable bitrate (Kbps): <input type="number" id="maxBitrate1" value="5000"> 
                    </div>
                    <div>
                        Min selectable bitrate (Kbps): <input type="number" id="minBitrate1" value="-1">
                    </div>
                    <div>
                        Select ABR algorithm: 
                        <select type="dropdown" id="abr1">
                            <option value="default">Default</option>
                            <option value="LowestBitrateRule">Lowest Bitrate</option>
                            <option value="DownloadRatioRule">Download Ratio Rule</option>
                            <option value="ThroughputRule">Throughput Rule</option>
                         </select>
                    </div>
                    <div>
                        Change ABR?: <input type="checkbox" id="changeabr1">
                    </div>
                    <div>
                        <button onclick="configurePlayback(1)">Apply changes</button>
                    </div>
                </fieldset>
            </div>
        </div>
        <div>
            <div class="dash-video-player " style = "float: left;">
                <!-- HTML structure needed for the ControlBar -->
                <div class="videoContainer_2" id="videoContainer_2">
                    <video class="dashjs-player2" preload="auto" autoplay="true"> </video>
                    <div id="videoController_2" class="video-controller unselectable">
                        <div id="playPauseBtn_2" class="btn-play-pause" title="Play/Pause">
                            <span id="iconPlayPause_2" class="icon-play"></span>
                        </div>
                        <span id="videoTime_2" class="time-display">00:00:00</span>
                        <div id="fullscreenBtn_2" class="btn-fullscreen control-icon-layout" title="Fullscreen">
                            <span class="icon-fullscreen-enter"></span>
                        </div>
                        <div id="bitrateListBtn_2" class="control-icon-layout" title="Bitrate List">
                            <span class="icon-bitrate"></span>
                        </div>
                        <input type="range" id="volumebar_2" class="volumebar" value="1" min="0" max="1" step=".01">
                        <div id="muteBtn_2" class="btn-mute control-icon-layout" title="Mute">
                            <span id="iconMute_2" class="icon-mute-off"></span>
                        </div>
                        <div id="trackSwitchBtn_2" class="control-icon-layout" title="A/V Tracks">
                            <span class="icon-tracks"></span>
                        </div>
                        <div id="captionBtn_2" class="btn-caption control-icon-layout" title="Closed Caption">
                            <span class="icon-caption"></span>
                        </div>
                        <span id="videoDuration_2" class="duration-display">00:00:00</span>
                        <div class="seekContainer">
                            <div id="seekbar_2" class="seekbar seekbar-complete">
                                <div id="seekbar-buffer_2" class="seekbar seekbar-buffer"></div>
                                <div id="seekbar-play_2" class="seekbar seekbar-play"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div style="margin-bottom: 200px">
                <strong>Player 2 Statistics</strong>
                </br>
                <strong>Reported bitrate:</strong>
                <span id="reportedBitrate2"></span>
                <br />
                <strong>Buffer level:</strong>
                <span id="bufferLevel2"></span>
                <br />
                <strong>Calculated bitrate:</strong>
                <span id="calculatedBitrate2"></span>
                <fieldset>
                    <legend>Configuration parameters</legend>
                    <div>
                        Max stable buffer (seconds): <input type="number" id="stableBuffer2" value="20">
                    </div>
                    <div>
                        Buffer length at top quality (seconds): <input type="number" id="topQualityBuffer2" value="20">
                    </div>
                    <div>
                        Max selectable bitrate (Kbps): <input type="number" id="maxBitrate2" value="5000"> 
                    </div>
                    <div>
                        Min selectable bitrate (Kbps): <input type="number" id="minBitrate2" value="-1">
                    </div>
                    <div>
                        Select ABR algorithm: 
                        <select type="dropdown" id="abr2">
                            <option value="default">Default</option>
                            <option value="LowestBitrateRule">Lowest Bitrate</option>
                            <option value="DownloadRatioRule">Download Ratio Rule</option>
                            <option value="ThroughputRule">Throughput Rule</option>
                         </select>
                    </div>
                    <div>
                        Change ABR?: <input type="checkbox" id="changeabr2">
                    </div>
                    <div>
                        <button onclick="configurePlayback(2)">Apply changes</button>
                    </div>
                </fieldset>
            </div>
        </div>
    </body>
</html>